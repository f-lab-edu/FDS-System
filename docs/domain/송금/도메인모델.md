# 송금 도메인 모델 정의서 (v2)

## 1. 도메인 설명

송금(Transfer)은 시스템 내 사용자가 다른 사용자에게 금액을 전송하는 하나의 트랜잭션이다.  
송금은 요청-처리-완료/실패-이력기록의 전체 흐름을 포함한다.

> 이후에는 정정(보정)이나 리스크 평가로 확장될 수 있다.

송금은 단순한 상태 전이 뿐 아니라 다음을 포함한다:

- 금액 이동 (잔액 차감/증가)
- 정정 기록 (correction_log)
- 상태 변경 이력 (tx_history)
- 관리자의 보정 개입 가능성
- 향후 이상거래 분석 대상 (risk_logs 연계)
- 장애/오류 상황 기록 가능성 (dlq_events)

## 2. Transfer 애그리거트 (Aggregate Root)

### 개념

송금은 하나의 Aggregate로 모델링되며, 다음의 규칙을 가진다:

- 출금자와 입금자는 같을 수 없다
- 금액은 0보다 커야 한다
- 상태 전이만으로 성공/실패가 구분된다
- 상태 변경은 반드시 기록(tx_history)된다
- 정정은 1회에 한해 보정 가능하며, 관리자 권한이 필요하다

### 속성

| 필드 | 타입 | 설명 |
|------|------|------|
| `id` | TransferId (Long (Snowflake)) | 송금 고유 식별자 |
| `fromMemberId` | Long (Snowflake) | 보내는 사용자 ID |
| `toMemberId` | Long (Snowflake) | 받는 사용자 ID |
| `amount` | Money (bigint) | 송금 금액 |
| `status` | TransferStatus | 현재 상태 |
| `requestedAt` | datetime | 송금 요청 시각 |
| `completedAt` | datetime? | 송금 처리 시각 |
| `corrected` | Boolean | 정정 여부 플래그 (default: false) |

### 상태 (TransferStatus)

- `PENDING`: 송금 요청됨 (처리 전)
- `COMPLETED`: 성공적으로 완료됨
- `FAILED`: 실패
- `CORRECTED`: 관리자가 금액 정정을 수행함

### 행위 (도메인 메서드)

| 메서드 | 설명 |
|--------|------|
| `Transfer.create(...)` | 요청값을 기반으로 송금 객체 생성 (기본 검증 포함) |
| `complete()` | 송금을 성공 상태로 전이 |
| `fail()` | 송금을 실패 상태로 전이 |
| `correct(amount, adminId, reason)` | 정정 수행, correction_log 생성 트리거 |
| `recordStatusChange(prev, next, adminId?)` | 상태 변경 이력 저장 |

## 3. 이벤트 연동 고려 (도메인 외부 흐름과 연결)

| 이벤트 | 목적 | 연계 테이블 |
|--------|------|--------------|
| `TransferCreatedEvent` | 송금 요청됨 → 분석 / 큐잉 | risk_logs |
| `TransferCompletedEvent` | 성공 처리됨 → 계좌 입금 | account_balances |
| `TransferFailedEvent` | 실패 처리됨 → DLQ 기록 | dlq_events |
| `TransferCorrectedEvent` | 정정 발생 → correction_log | correction_log |

## 4. 보완 포인트 반영 정리

| 항목 | 반영 여부 | 설명 |
|------|-----------|------|
| 정정 처리 | `corrected`, `correct()` |
| 상태 변경 이력 | `tx_history` 연계 |
| 관리자 개입 | 정정 및 상태 변경 시 adminId 보관 |
| 실패 기록 | `TransferFailedEvent` → DLQ 가능 |
| 분석 연동 | `TransferCreatedEvent` → risk_logs 대상됨

## 5. 설계 요약

- Transfer는 단순한 데이터가 아닌 상태 주도 모델
- 상태 전이/정정/이력/연동이 명확히 존재
- 도메인 모델로 캡슐화할 가치가 충분한 Aggregate
